#报销单头行结构功能开发
####1. Git地址信息
    后端项目git地址：https://code.choerodon.com.cn/hand-rongjing-hcf-train/train.git
    前端项目git地址：https://code.choerodon.com.cn/hand-rongjing-hec/hcf-front.git
    前端依赖包 npm install
    前端启动 npm run start
####2. 登录信息
    Token调用地址：http://47.101.145.62:9081/auth/oauth/token
    Authorization：Basic QXJ0ZW1pc0FwcDpuTENud2RJaGl6V2J5a0h5dVpNNlRwUURkN0t3SzlJWERLOExHc2E3U09X
    username:   admin
    password:   hly123
    grant_type: password
    scope:      write
    
    postmen collection：https://www.getpostman.com/collections/0b914584b29fd3b0e276
###一．后端开发
####1. 表结构
+ 报销单头表 tra_report_header
    字段名称|字段类型|可空|字段说明
    --|:--:|--:|--:
    id|数值类型（bigint）|否|ID
    business_code|字符类型（varchar）|否|报销单头编码
    company_id|数值类型（bigint）|否|公司id
    unit_id|数值类型（bigint）|否|部门id
    total_amount|数值类型（double）|是|行总金额
    application_id|数值类型（bigint）|否|申请人id
    remark|字符类型varchar(100)|是|说明
    tenant_id|数值类型（bigint）|否|租户id
    set_of_books_id|数值类型（bigint）|否|账套id
    report_date|时间类型(TIMESTAMP)|是|报账日期
    report_status|字符类型varchar(50)	|是|报账单状态
    deleted|字符类型(boolean)|否|删除标志
    version_number|数值类型(int)|否|版本号
    created_date|时间类型(TIMESTAMP)|否|创建日期
    created_by|数值类型(bigint)|否|创建用户ID
    last_updated_date|时间类型(TIMESTAMP)|否|最后更新日期
    last_updated_by|数值类型(bigint)|否|最后更新用户ID

+ 报销单行表 tra_report_line
    字段名称|字段类型|可空|字段说明
    --|:--:|--:|--:
    id|数值类型（bigint）|否|ID
    header_id|数值类型bigint|否|头表ID
    line_number|数值类型int|否|行号
    invoice_code|字符类型varchar(100)|否|发票代码
    invoice_number|字符类型varchar(100)|否|发票号码
    invoice_amount|数值类型（bigint）|否|发票金额
    invoice_date|日期类型（TIMESTAMP）|否|发票日期
    remark|字符类型varchar(100)|是|说明
    deleted|字符类型(boolean)|否|删除标志
    version_number|数值类型(int)|否|版本号
    created_date|时间类型(TIMESTAMP)|否|创建日期
    created_by|数值类型(bigint)|否|创建用户ID
    last_updated_date|时间类型(TIMESTAMP)|否|最后更新日期
    last_updated_by|数值类型(bigint)|否|最后更新用户ID
####2. Liquibase建表
按版本在liquibase文件下创建文件夹，如 version.1.0.0

在version目录下创建具体执行文件，命名为release+日期(该文件由管理人员创建，视情况命名，可按迭代等分开)，新增changeSet(仅限于新增数据库对象的changeSet)需放在对应版本最新release文件中，sql文件等需要在每个version目录单独创建文件夹存放

项目成员不允许私自添加version目录以及release文件

changeSet规范如下：
1. 严禁修改已有changeSet
2. changeSet中只能包含表结构和已初始化系统数据的修改，杜绝出现业务数据修改
3. id为日期时间(年月日时分)+序号(3位数)，例如：201901011111001；author为姓名拼音，一般为名.姓，如san.zhang(张三)
4. table与column必须加入remarks进行备注
5. 所有表不允许创建外键
6. 表名不允许使用复数
7. 数据库对象名长度不能超过30个字符，名称过长时，需要缩写
8. 索引名称规范：主键为pk_+表名，如sys_user表主键为pk_sys_user；
	唯一索引为 表名 + _u序号，如sys_user_u1；
	普通索引为 表名 + _n序号，如sys_user_n1
9. 同一版本中，操作同一张表(包括修改结构及初始化数据)，需要放到同一个release文件中
####3. Domain类
+ `domain`类不需要提供任何实现，所以属于供应方的服务接口层。创建在 项目模块 的`xxx.<module>.domain`包下
+ 每一个`domain`类即为一个实体类，对应数据库中的一个具体表
+ 名称与表名称相同，表名中`_`替换为驼峰命名法，首字母大写，若表中涉及到缩写，需要修改为原单词，如`tra_report_header`对应实体类`TrainingReportHeader`
+ `@TableName("tra_report_header")`指定`domain`对应数据库中表的名称
+ 用`@Data`注解代替`getter`、`setter`方法
+ 所有`domain`类必须继承`Domain`实体类，根据需要选择继承`Domain`、`DomainLogic`、`DomainEnable`、`DomainLogicEnable`等实体类
####4. dto
+ `DTO`类不需要提供任何实现，所以属于供应方的服务接口层
+ 名称根据实际业务含义而定，一般和`domain`类命名一致，以`DTO`结尾，即`domain`类名 + `DTO`
####5. persistence持久化
+ 创建在`项目模块`的`xxx.<module>.persistence`包下
+ 每一个`Mapper`接口类封装了对数据库表的操作，每一个`Mapper`对应一个`domain`类，所以命名为`domain`类名 + `Mapper`。如：`TrainingReportHeaderMapper`对应表为`TrainingReportHeader`类
+ 基础的CRUD操作不需要再次实现，通过继承`BaseMapper<T>`类实现。其中`T`为 对应`domian`的泛型
+ 复杂的数据库操作需要定义具体的接口方法
####6. Service逻辑处理
+ Service 类定义了业务操作的一系列实现方法，属于供应方的服务实现层。创建在 项目模块 的 xxx.<module>.service 包下。
+ 命名如：`TrainingReportHeaderService`对应表为`TrainingReportHeader`类
+ Service类，如无特殊例外，需要继承`BaseService<M,T>`类，`M`为`Mapper`接口类，`T`为`domain`类
+ 通过`@Service`标注，表名此类为Service类，并通过Spring自动注入
####7. Controller接口
+ Controller负责对Model和View的处理，创建在`项目模块`的`xxx.<module>.web`包下
+ 每一个`Controller`是对一个具体的`domain`资源进行处理的，所以命名为`domain`类名 + `Controller`。如：`TrainingReportHeaderController`对应`TrainingReportHeader`类。
+ 需要通过`@RestController`指定该类为一个`Controller`类
+ 需要在每一个`Controller`中通过`@Autowired`注入Service
+ `Controller`的每一个方法只在最后调用一次该`Controller`所注入的`Service`，因此当有调用多个Service的需求应该放在注入的`Service`中
+ 增`Post`、删`Delete`、改`Put`、查`Get/Post`
####8. 异常处理
业务异常用`Bizexception`捕获，如：
```java
if (header.getId() == null) {
            throw new BizException(RespCode.ID_NULL);
        }
```
####9. 多语言实现
+ 在Spring托管的类使用@I18nDomainScan,扫描继承了I18nDomain的实体类。
  如：在`ServiceApplication`类上`@I18nDomainScan({“com.hand.hcf.app.train.domain”})`
+ 建表。如果原来的表名是：tra_message,那么新建的其对应的多语言表表名强制要求为：tra_message_i18n，即增加“_i18n”，同时表内字段为：id、language、以及若干多语言字段。 这里强制要求id、language为联合主键，使用liquibase建表changeset如下：
```xml
<changeSet id="201901101052002" author="shouting.cheng">
        <createTable tableName="tra_message_i18n" remarks="消息多语言表">
            <column name="id" type="bigint" defaultValue="0" remarks="">
                <constraints nullable="false"/>
            </column>
            <column name="language" type="varchar(20)" remarks="语言">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(100)" remarks="消息名称">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="tra_message_i18n" columnNames="id,language" constraintName="tra_message_i18n_u1"/>
    </changeSet>
```
+ 与多语言表对应的`domain`表必须包含`deleted`字段，对应`domain`类里的多语言字段需用`@I18nField`注解
+ 多语言插入、更新时只需要在新建传参时加上`i18n`字段即可，如：
```json
{
	"i18n": {
		"name": [
		    {
		       "language": "zh_cn",
		       "value": "维度"
		    },
		    {
		        "language": "en",
		        "value": "dimension"
		    }
		]
	},
	"code": "dimension",
	"name": "维度"
}
```
+ 查询时需要通过baseI18nService手动查询，如：
```java
dimension.setI18n(baseI18nService.getI18nMap(Dimension.class, dimension.getId()));
```
####10. 文档API编写
1. 安装apidoc。首先要确认你的系统安装了nodejs，然后执行`npm install -g apidoc`即可。
2. 配置apidoc。在项目根目录新建apidoc.json，内容如下：
```json
{
  "name": "项目名称",
  "version": "项目版本",
  "description": "项目介绍",
  "title": "浏览器显示的标题内容",
  "url" : "API前缀"
}
```
3. 常用的ApiDoc
+ @apiGroup 定义API的分组
+ @api  定义API的请求方法、路径和名字
+ @apiDescription 定义API的描述
+ @apiGroup 定义API的分组
+ @apiParam 定义API的参数
+ @apiParamExample 参数请求的示例
+ @apiSuccessExample API成功示例
+ @apiErrorExample API错误示例
4. 生成文档
+ 执行命令`apidoc -i src/ -o apidoc/`
###二．前端开发
![列表](https://code.choerodon.com.cn/hand-rongjing-hcf-train/train/raw/development/src/main/resources/pictures/list.png)
![新建](https://code.choerodon.com.cn/hand-rongjing-hcf-train/train/raw/development/src/main/resources/pictures/new.png)
####1. React常用知识
1) 参数范围：this.state,  this.props      

2) 改变值： this.setState({    }) , 是一个异步方法， this.setState({    }, () => { } )

3) React的常用生命周期：
    a) constructor(props) 构造函数，创建组件的时候调用一次。, super(props); 必须写在里面的第一行
    b) componentWillMount()  在组件挂载之前调用一次，一般用于界面初始化加载
    c) componentDidMount()  在组件挂载之后调用一次。这个时候，子主键也都挂载好了，可以在这里使用refs
    d) componentWillReceiveProps(nextProps) props是父组件传递给子组件的。父组件发生render的时候子组件就会调用
####2. 开发步骤
1) 定义多语言（系统管理-多语言管理-中文-menu）
        添加Key
2) 定义菜单 
        根菜单：(系统管理-菜单管理-添加根菜单)
            路由与代码相同，来源选本地，加图标
        子菜单：(系统管理-菜单管理-编辑)
            路由与代码相同，来源选本地，不加图标
3) 分配菜单
        角色管理-分配菜单-勾选相应菜单
4) 修改src/common/router.js 文件 ，指向具体的文件即可，name是tab的名称
```js
//预算日记本
'/budget/budget-journal': {
    component: dynamicWrapper(app, [], () =>
        import('containers/budget/budget-journal/budget-journal.js')
    ),
    name: 'budget-journal',
},
    
//新建预算日记账
'/budget/budget-journal/new-budget-journal': {
    component: dynamicWrapper(app, [], () =>
        import('containers/budget/budget-journal/new-budget-journal.js')
    ),
    name: '新建预算日记账',
    parent: '/budget/budget-journal',
},
```
5) 绘制界面
6) 与后端交互
####3. 注意事项
1) `mapStateToProps`初始化值
```js
function mapStateToProps(state) {
    return {
        company: state.user.company,
        user: state.user.currentUser,
        language: state.languages.languages,
        organization: state.user.organization,
        
        tenantMode:true
    }
}
```
2) 获取上个页面传过来的值`this.props.match.params`
3) 跳转路由需要先导入routerRedux（`import { routerRedux } from "dva/router";`），当前页面必须使用connect包装一下。（使用connect需先导入`import { connect } from 'dva';`）
```js
this.props.dispatch(
    routerRedux.push({
        pathname: `/budget/budget-journal/budget-journal-detail/${response.data.dto.id}`,
    })
);
```
4) scss里所有样式必须要用`:global`包起来
5) 多语言用`this.$t()`
6) `<Select>`下拉时，`Option` 一定要添加 `value`（可同`Key`值）